
---
title: "TEMA 7. CLASIFICACIÓN Y DISCRIMINACION.(1)"
output: html_document
---



## ESTADÍSTICA COMPUTACIONAL

**GRADO EN INGENIERÍA INFORMÁTICA-INGENIERÍA DEL SOFTWARE**

**GRADO EN INGENIERÍA INFORMÁTICA- TECNOLOGÍAS INFORMÁTICAS**

**Juan M. Muñoz Pichardo - María Dolores Cubiles de la Vega**

**Departamento de Estadística e I.O. Universidad de Sevilla**

____________________________________________________________________

PRIMER SCRIPT DEL DESARROLLO TEÓRICO DEL TEMA

ANÁLISIS DISCRIMINANTE LINEAL CLASICO BAJO CONDICIONES DE NORMALIDAD

Funciones:  "lda"   
             Estimación de tasas a través del método Holdout
   


Datos: salmon.dat

Librerías necesarias:  MASS, graphics



###LECTURA FICHERO DE DATOS 

Estudio sobre los salmones en función de su origen

Variables:

 - SalmonOrigin : Origen del salmon (Canadá - Alaska)
 
 - Freshwater   : diámetro (en 1/100 de pulgada) de los anillos sobre las escamas en el crecimiento del primer año en agua dulce 
 
 - Marine       : diámetro (en 1/100 de pulgada) de los anillos sobre las escamas en el crecimiento del primer año en agua dulce 


```{r}

library(graphics)
library(MASS)

datos <- read.table("salmon.dat", header=TRUE)
names(datos)
dim(datos)

```


Representación gráfica de los datos:

```{r}

plot(datos[,-1],col=as.factor(datos[,1]), pch=19)
legend("bottomleft",legend=levels(datos$SalmonOrigin),col=c(1,2),pch=c(19,19))

```







### NOTAS PARA LA OBTENCIÓN DEL ANÁLISIS DISCRIMINANTE LINEAL: lda


Es necesario cargar la librería MASS library(MASS)   

#### Esquema de la orden 
Orden :  lda(formula,datos,prior,subset,...)

**PARÁMETROS: **

 - **formula**  : Indica la variable de agrupación y las Variables discriminantes que deben ser incluidas en el análisis. 
 
 *Ejemplo: vargrupo ~ x1 + x2 + x3*
 
 - **datos**    : data frame que contiene las variables indicadas.
 
Alternativamente, en lugar de "formula" se puede proporcionar el par "datos y variable grupo":
 
 - **grouping** : factor o variable grupo

 - **prior**    : Probabilidades a priori. Si no se indican, se utilizan las proporciones del conjunto de entrenamiento o proporciones muestrales.
 
 - **subset**   : Un vector de índices especificando los casos que deben usarse en la muestra de entrenamiento.

 *Ejemplo:    *

   *"> muestraentrenamiento <- sample(1:200,150) "*
   
   *"> lda(vargrupo ~ .,datos, subset=muestraentrenamiento) " *

 - **na.action** : función para especificar la acción en caso de datos perdidos. Por defecto, el procedimiento falla y no se realiza. Alternativa, na.omit, que conduce al rechazo de los casos con valores perdidos en cualquier variable deseada. 

 - **method    : método de estimación (moment, mle, mve, t).** 
 
 - method="moment" para los estimadores estándar de la media y la varianza.
 
 - method="mle"    para estimadores de máxima verosimilitud
 
 - method="mve"    para estimadors robustos de localización y dispersión (véase cov.mve)
 
 - method="t"      para estimaciones robustos basados en la distribución t

 - **CV**        : Si "TRUE", incluye en los resultados las clases o gurpos asignados y las probabilidades a posterior, a través del método de validación cruzada leave-one-out. 
 
 - **nu**        : grados de libertad en caso de que se utilice el método "t"


#### Resultados:

Si CV = TRUE, proporciona una lista con componentes: "class", clasificación realizada, y "posterior", probabilidades a posteriori. 

En otro caso, el objeto contiene:

 - **prior**      : probabilidades a priori utilizados.
 - **means**      : medias de los grupos
 - **scaling**    : Matriz que transforma las observaciones a las funciones discriminantes, normalizadas  de forma que la matriz de varianzas y covarianzas de los grupos sea esférica.
 - **svd**        : valores singulares, que proporcionan la razón de las desviaciones estandar entre los grupos y dentro de las variables discriminantes lineales. 
 - **N**          : número de observaciones utilizadas


### REALIZACIÓN DEL ANÁLISIS DISCRIMINANTE CON MÉTODO HOLDOUT 

Análisis discriminate sobre el conjunto de datos considerando 10 casos de cada grupo como conjunto test, y los restantes casos como conjunto de aprendizaje.

Primero, selección de los conjuntos de aprendizaje y test

```{r}
aprdat=datos[c(1:40,51:90),]   # conjunto de "entrenamiento" o "aprendizaje"
testdat=datos[c(41:50,91:100),]  # conjunto "test"

```

Aplicación de la técnica discriminante

```{r}

aprdat.lda=lda(aprdat[,c(2,3)],grouping=aprdat[,1])
aprdat.lda

```

Los atributos del objeto de clase "lda" que se ha creado son:
"prior", "counts" (número de casos), "means", "scaling", "lev" (niveles de la variable agrupación), "svd", "N" (número total de casos) y "call" (orden)   

```{r}
attributes(aprdat.lda)
aprdat.lda$prior
aprdat.lda$counts
aprdat.lda$N
aprdat.lda$means
aprdat.lda$scaling
aprdat.lda$lev
aprdat.lda$svd

```



#### Determinación del eje obtenido por el análisis discriminante

Dado que la matriz de transformación ("scaling") determina la primera (en este caso única) coordenada discriminante, el nuevo eje asociado viene dado por:

    s1 * (Freshwater - mcFres) + s2 * (Marine - mcMarine) = 0 

siendo s1 y s2 los coeficientes de la transformación "scaling", mcFres y mcMarine las medias "conjuntas" o globales de las variables respectivas. Expresando la ecuación anterior de forma implícita:

  
    Marine = [ mcMarine + (s1/s2) * mcFres ] - (s1/s2) * Freshwater

**Representación gráfica**

```{r}
medconj=c(mean(aprdat[,2]),mean(aprdat[,3])) # Punto medio conjunto de todos los datos
pend.eje=-aprdat.lda$scaling[1]/aprdat.lda$scaling[2] # pendiente del eje
intercept.eje=-pend.eje*medconj[1]+medconj[2] # intercept del eje

plot(datos[,-1],col=as.factor(datos[,1]), pch=19, xlim=c(25,225))
legend("bottomleft",legend=levels(datos$SalmonOrigin),col=c(1,2),pch=c(19,19))
abline(a=intercept.eje,b=pend.eje,col="blue")
points(medconj[1],medconj[2],pch=15,cex=2,col="blue")
points(aprdat.lda$means[1,][1],aprdat.lda$means[1,][2],pch=15,cex=2)
points(aprdat.lda$means[2,][1],aprdat.lda$means[2,][2],pch=15,cex=2,col="red")

```

**Nota**: el punto medio conjunto de los datos también se podía haber obtenido con las órdenes:

- mean(aprdat$Freshwater)  # media global primera variable
- mean(aprdat$Marine)      # media global segunda variable



### Clasificación y Estimación de tasas de error

#### Clasificación sobre el conjunto test

Con objeto de validar la regla discriminante obtenida, se procede a utilizar el conjunto test que se ha reservado del conjunto inicial de datos. 

El objeto resultante de la orden "predict" es una lista que contiene un registro para cada dato incluido en el conjunto test con: clase o grupo al que pertenece ("class"), probabilidades a posteriori de pertenecer a cada uno de los grupos ("posterior") y puntuación obtenida en la coordenada discriminante ("x")


```{r}
testpred <- predict(aprdat.lda, testdat[,c(2,3)])
names(testpred)
testpred

```



Como comprobación de la puntuación obtenida para cada caso test, analicemos el primer caso.

```{r}
testdat[1,]  # Datos originales del caso "1"
testpred$x[1]  # Transformación del caso "1" al espacio discriminante

# Otra forma de cálculo de la coordenada discriminante
aprdat.lda$scaling[1]*(testdat[1,2]-medconj[1])+aprdat.lda$scaling[2]*(testdat[1,3]-medconj[2])

testdat$SalmonOrigin[1] # Clase o grupo original del caso
testpred$class[1] #       Clase o grupo asignado por la regla discriminate

```


Tabla de clasificacion correctos/incorrectos para todos los casos incluidos en el conjunto test:

```{r}
ct <- table(testdat$SalmonOrigin, testpred$class)
ct

```


Porcentaje correcto por grupos
```{r}
diag(prop.table(ct, 1))

```

Total porcentaje correcto
```{r}
sum(diag(prop.table(ct)))
```



#### Clasificación sobre un caso nuevo

Aplicación de la regla discriminante para clasificar un nuevo caso. 

Caso con Freshwater=120,Marine=380
```{r}
predict(aprdat.lda,c(120,380))  
attributes(predict(aprdat.lda,c(120,380)))
predict(aprdat.lda,c(120,380))$x
predict(aprdat.lda,c(120,380))$class
predict(aprdat.lda,c(120,380))$posterior
```



Caso con Freshwater=100,Marine=475
```{r}
predict(aprdat.lda,c(100,475))  
attributes(predict(aprdat.lda,c(100,475)))
predict(aprdat.lda,c(100,475))$x
predict(aprdat.lda,c(100,475))$class
predict(aprdat.lda,c(100,475))$posterior

```





### Visualización de algunos resultados

 Histogramas de las muestras iniciales transformadas


```{r}
plot(aprdat.lda) 
```


Plot de la partición del plano realizada:

```{r}
library(klaR)
partimat(SalmonOrigin~Freshwater+Marine,data=aprdat,method="lda",
         main="Plot partición del espacio muestral. Datos de aprendizaje") 
partimat(SalmonOrigin~Freshwater+Marine,data=datos,method="lda",
         main="Plot partición del espacio muestral. Datos completos")

```

 
